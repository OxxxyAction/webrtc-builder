name: Build WebRTC Universal AAR

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch: [arm64, armv7]
    timeout-minutes: 180

    steps:
      # ---------------- Checkout ----------------
      - uses: actions/checkout@v4

      # ---------------- Free disk space ----------------
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo docker system prune -af || true
          df -h

      # ---------------- Install dependencies ----------------
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git python3 python3-pip openjdk-17-jdk \
            ninja-build curl unzip

      # ---------------- Setup depot_tools ----------------
      - name: Setup depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$PWD/depot_tools" >> $GITHUB_PATH

      # ---------------- Fetch WebRTC ----------------
      - name: Fetch WebRTC with hooks
        run: |
          fetch webrtc
          cd src
          gclient sync
          gclient runhooks

      # ---------------- Generate GN build ----------------
      - name: Generate GN build
        run: |
          cd src
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            OUT=out/android_arm64
            TARGET_CPU="arm64"
          else
            OUT=out/android_armv7
            TARGET_CPU="arm"
          fi

          gn gen $OUT --args='
            target_os="android"
            target_cpu="'$TARGET_CPU'"
            is_debug=false
            is_component_build=false
            rtc_build_examples=false
            rtc_include_tests=false
            use_rtti=true
            is_clang=true
            symbol_level=0
            rtc_use_h264=true
            extra_ldflags=["-Wl,-z,max-page-size=16384"]
          '

      # ---------------- Build libwebrtc ----------------
      - name: Build libwebrtc
        run: |
          cd src
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            ninja -C out/android_arm64 sdk/android:libwebrtc
          else
            ninja -C out/android_armv7 sdk/android:libwebrtc
          fi

      # ---------------- Build AAR ----------------
      - name: Build AAR
        run: |
          cd src
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            python3 tools_webrtc/android/build_aar.py \
              --build-dir out/android_arm64 \
              --output webrtc-arm64.aar
          else
            python3 tools_webrtc/android/build_aar.py \
              --build-dir out/android_armv7 \
              --output webrtc-armv7.aar
          fi

      # ---------------- Upload artifacts for merge ----------------
      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-${{ matrix.arch }}
          path: src/webrtc-*.aar

  merge:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge AARs into universal
        run: |
          mkdir universal
          unzip artifacts/webrtc-arm64/webrtc-arm64.aar -d universal/arm64
          unzip artifacts/webrtc-armv7/webrtc-armv7.aar -d universal/armv7

          # Копіюємо файли з armv7
          cp -R universal/armv7/* universal/

          # Замінюємо jni libs arm64
          mkdir -p universal/jni/arm64-v8a
          cp -R universal/arm64/jni/arm64-v8a/* universal/jni/arm64-v8a/

          # Створюємо final AAR
          cd universal
          zip -r ../webrtc-universal.aar *

      - name: Upload universal AAR
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-universal-aar
          path: webrtc-universal.aar

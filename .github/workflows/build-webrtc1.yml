name: Build WebRTC AAR (16KB)

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        arch: [arm64, armv7]
    runs-on: ubuntu-22.04

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo docker system prune -af || true
          df -h

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git python3 openjdk-11-jdk \
            ninja-build

      - name: Setup depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$PWD/depot_tools" >> $GITHUB_PATH

      - name: Fetch WebRTC
        run: |
          fetch --nohooks --no-history webrtc
          cd src
          gclient sync --no-history
          gclient runhooks

      - name: Generate build files
        run: |
          cd src
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            OUT=out/android_arm64
            TARGET_CPU="arm64"
          else
            OUT=out/android_armv7
            TARGET_CPU="arm"
          fi

          gn gen $OUT --args='
            target_os="android"
            target_cpu="'$TARGET_CPU'"
            is_debug=false
            rtc_use_h264=true
            rtc_enable_protobuf=false
            rtc_build_examples=false
            rtc_build_tests=false
            use_custom_libcxx=false
            treat_warnings_as_errors=false
            use_rtti=true
            rtc_enable_symbol_export=true
            enable_libaom=false
            rtc_include_tests=false
            android_enable_16kb_pages=true
          '

      - name: Build libwebrtc
        run: |
          cd src
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            ninja -C out/android_arm64 sdk/android:libwebrtc
          else
            ninja -C out/android_armv7 sdk/android:libwebrtc
          fi

      - name: Upload .so
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-${{ matrix.arch }}
          path: src/out/android_*/obj/**/*.so

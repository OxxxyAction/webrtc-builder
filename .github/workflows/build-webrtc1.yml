name: Build WebRTC AAR (16KB)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # ---------------- Cache depot_tools ----------------
      - name: Cache depot_tools
        id: cache-depot
        uses: actions/cache@v4
        with:
          path: ~/depot_tools
          key: depot-tools-v1

      - name: Clone depot_tools
        if: steps.cache-depot.outputs.cache-hit != 'true'
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $HOME/depot_tools

      - name: Add depot_tools to PATH
        run: echo "$HOME/depot_tools" >> $GITHUB_PATH

      # ---------------- Cache WebRTC checkout ----------------
      - name: Cache WebRTC source
        id: cache-webrtc
        uses: actions/cache@v4
        with:
          path: webrtc-checkout
          key: webrtc-source-v1

      - name: Fetch WebRTC (with hooks)
        if: steps.cache-webrtc.outputs.cache-hit != 'true'
        run: |
          mkdir webrtc-checkout
          cd webrtc-checkout
          fetch webrtc

      - name: Install build deps
        run: |
          cd webrtc-checkout/src
          ./build/install-build-deps.sh --no-prompt

      # ---------------- ARM64 build ----------------
      - name: Generate GN build (arm64)
        run: |
          cd webrtc-checkout/src
          gn gen out/android_arm64 --args='
            target_os="android"
            target_cpu="arm64"
            is_debug=false
            is_component_build=false
            rtc_build_examples=false
            rtc_include_tests=false
            use_rtti=true
            is_clang=true
            symbol_level=0
            rtc_use_h264=true
            extra_ldflags=["-Wl,-z,max-page-size=16384"]
          '

      - name: Build WebRTC (arm64)
        run: |
          cd webrtc-checkout/src
          ninja -C out/android_arm64 sdk/android:libwebrtc

      - name: Create AAR (arm64)
        run: |
          cd webrtc-checkout/src
          python3 tools_webrtc/android/build_aar.py \
            --build-dir out/android_arm64 \
            --output webrtc-arm64.aar

      # ---------------- ARMv7 build ----------------
      - name: Generate GN build (arm)
        run: |
          cd webrtc-checkout/src
          gn gen out/android_arm --args='
            target_os="android"
            target_cpu="arm"
            is_debug=false
            is_component_build=false
            rtc_build_examples=false
            rtc_include_tests=false
            use_rtti=true
            is_clang=true
            symbol_level=0
            rtc_use_h264=true
            extra_ldflags=["-Wl,-z,max-page-size=16384"]
          '

      - name: Build WebRTC (arm)
        run: |
          cd webrtc-checkout/src
          ninja -C out/android_arm sdk/android:libwebrtc

      - name: Create AAR (arm)
        run: |
          cd webrtc-checkout/src
          python3 tools_webrtc/android/build_aar.py \
            --build-dir out/android_arm \
            --output webrtc-arm.aar

      # ---------------- Merge AARs ----------------
      - name: Merge into universal AAR
        run: |
          mkdir output
          unzip webrtc-checkout/src/webrtc-arm64.aar -d arm64
          unzip webrtc-checkout/src/webrtc-arm.aar -d arm

          cp -R arm/* output/
          cp -R arm64/jni/arm64-v8a output/jni/

          cd output
          zip -r ../webrtc-universal.aar *

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: webrtc-16kb-aar
          path: webrtc-universal.aar
